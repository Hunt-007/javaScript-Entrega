<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tienda Online</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        padding: 20px;
        background-color: #f8f9fa;
      }
      .product-img {
        height: 200px;
        object-fit: contain;
      }
      #cart {
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4 text-center">
        <i class="bi bi-cart4"></i> Tienda Online
      </h1>

      <div id="alert-area"></div>

      <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
          <label for="categorySelect" class="form-label fw-bold"
            >Filtrar por categoría:</label
          >
          <select id="categorySelect" class="form-select d-inline-block w-auto">
            <option value="all">Todas</option>
          </select>
        </div>
        <button
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#cartModal"
        >
          <i class="bi bi-cart"></i> Ver Carrito
        </button>
      </div>

      <div id="product-container" class="row g-4"></div>
    </div>

    <!-- Modal Carrito -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form
          class="modal-content needs-validation"
          novalidate
          onsubmit="event.preventDefault(); simulatePayment();"
        >
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-cart3"></i> Tu Carrito</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <div id="cart"></div>
            <hr />
            <h6><i class="bi bi-person-vcard"></i> Datos del comprador</h6>
            <div class="mb-2">
              <input
                type="text"
                id="buyerName"
                class="form-control"
                placeholder="Nombre completo"
                required
              />
              <div class="invalid-feedback">Ingrese su nombre.</div>
            </div>
            <div class="mb-2">
              <input
                type="email"
                id="buyerEmail"
                class="form-control"
                placeholder="Correo electrónico"
                required
              />
              <div class="invalid-feedback">Ingrese un correo válido.</div>
            </div>
          </div>

          <div
            class="modal-footer d-flex justify-content-between align-items-center"
          >
            <strong>Total: $<span id="total"></span></strong>
            <div>
              <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-credit-card"></i> Pagar
              </button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="clearCart()"
              >
                <i class="bi bi-trash3"></i> Vaciar
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_BASE = "https://fakestoreapi.com";
      const productContainer = document.getElementById("product-container");
      const categorySelect = document.getElementById("categorySelect");
      const cartElement = document.getElementById("cart");
      const totalElement = document.getElementById("total");
      const alertArea = document.getElementById("alert-area");
      const buyerName = document.getElementById("buyerName");
      const buyerEmail = document.getElementById("buyerEmail");

      let allProducts = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      fetch(`${API_BASE}/products/categories`)
        .then((res) => res.json())
        .then((categories) => {
          categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat;
            option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categorySelect.appendChild(option);
          });
        });

      fetch(`${API_BASE}/products`)
        .then((res) => res.json())
        .then((data) => {
          allProducts = data;
          renderProducts(allProducts);
        });

      categorySelect.addEventListener("change", () => {
        const selected = categorySelect.value;
        if (selected === "all") {
          renderProducts(allProducts);
        } else {
          fetch(`${API_BASE}/products/category/${selected}`)
            .then((res) => res.json())
            .then((filtered) => renderProducts(filtered));
        }
      });

      function renderProducts(products) {
        productContainer.innerHTML = "";
        products.forEach((product) => {
          const col = document.createElement("div");
          col.className = "col-md-4 col-lg-3";
          const card = document.createElement("div");
          card.className = "card h-100 shadow-sm";
          card.innerHTML = `
          <img src="${product.image}" class="card-img-top product-img" alt="${product.title}">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title">${product.title}</h6>
            <p class="card-text">$${product.price}</p>
          </div>
        `;
          const button = document.createElement("button");
          button.className = "btn btn-primary mt-auto";
          button.innerHTML =
            '<i class="bi bi-cart-plus"></i> Agregar al carrito';
          button.addEventListener("click", () => addToCart(product));
          card.querySelector(".card-body").appendChild(button);
          col.appendChild(card);
          productContainer.appendChild(col);
        });
      }

      function addToCart(product) {
        const found = cart.find((item) => item.id === product.id);
        if (found) {
          found.qty++;
        } else {
          cart.push({ ...product, qty: 1 });
        }
        saveCart();
        showAlert(
          '<i class="bi bi-check-circle-fill"></i> Producto agregado al carrito',
          "success"
        );
      }

      function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }

      function renderCart() {
        cartElement.innerHTML = "";
        let total = 0;

        if (cart.length === 0) {
          cartElement.innerHTML =
            '<p class="text-muted">El carrito está vacío.</p>';
        } else {
          cart.forEach((item) => {
            total += item.price * item.qty;
            cartElement.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <strong>${item.title}</strong><br>
                $${item.price} x ${item.qty}
              </div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
          `;
          });
        }
        totalElement.textContent = total.toFixed(2);
      }

      function removeItem(id) {
        cart = cart.filter((item) => item.id !== id);
        saveCart();
        showAlert(
          '<i class="bi bi-trash3-fill"></i> Producto eliminado del carrito',
          "warning"
        );
      }

      function clearCart() {
        cart = [];
        saveCart();
        showAlert(
          '<i class="bi bi-x-octagon-fill"></i> Carrito vaciado',
          "danger"
        );
      }

      function simulatePayment() {
        const form = document.querySelector(".needs-validation");
        form.classList.add("was-validated");
        if (!form.checkValidity()) return;

        if (cart.length === 0) {
          showAlert(
            '<i class="bi bi-exclamation-circle-fill"></i> El carrito está vacío',
            "danger"
          );
          return;
        }

        const name = buyerName.value;
        const email = buyerEmail.value;
        const resumen = cart.map((i) => `• ${i.title} x ${i.qty}`).join("<br>");
        const total = cart
          .reduce((sum, item) => sum + item.price * item.qty, 0)
          .toFixed(2);

        showAlert(
          `<i class="bi bi-check2-circle"></i> ¡Gracias ${name}! Pago realizado por $${total}.`,
          "success"
        );
        cart = [];
        saveCart();

        buyerName.value = "";
        buyerEmail.value = "";
        bootstrap.Modal.getInstance(
          document.getElementById("cartModal")
        ).hide();
      }

      function showAlert(message, type = "info") {
        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        alertArea.appendChild(alert);
        setTimeout(() => alert.classList.remove("show"), 4000);
      }

      renderCart();
    </script>
  </body>
</html>
